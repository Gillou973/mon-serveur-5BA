<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test E-commerce API</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .auth-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }

        input, textarea, select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-right: 10px;
            margin-top: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button.secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        button.success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .status {
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            font-size: 14px;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .product-list, .category-list, .cart-items, .order-list {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .product-item, .category-item, .cart-item, .order-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .product-item h3, .category-item h3, .order-item h3 {
            color: #333;
            margin-bottom: 8px;
        }

        .product-item p, .category-item p, .cart-item p, .order-item p {
            color: #666;
            font-size: 13px;
            margin: 4px 0;
        }

        .price {
            color: #667eea;
            font-weight: bold;
            font-size: 18px;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            margin: 2px;
        }

        .badge.success {
            background: #28a745;
            color: white;
        }

        .badge.warning {
            background: #ffc107;
            color: #333;
        }

        .badge.danger {
            background: #dc3545;
            color: white;
        }

        .badge.info {
            background: #17a2b8;
            color: white;
        }

        .total-cart {
            background: #667eea;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            text-align: center;
        }

        .total-cart h3 {
            font-size: 24px;
        }

        pre {
            background: #f4f4f4;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }

        .hidden {
            display: none;
        }

        /* Variant Styles */
        .variant-list {
            max-height: 500px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .variant-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 15px;
            align-items: center;
        }

        .variant-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }

        .variant-info-item {
            display: flex;
            flex-direction: column;
        }

        .variant-info-label {
            font-size: 11px;
            color: #888;
            text-transform: uppercase;
            margin-bottom: 3px;
        }

        .variant-info-value {
            font-size: 13px;
            color: #333;
            font-weight: 500;
        }

        .variant-actions {
            display: flex;
            flex-direction: column;
            gap: 5px;
            min-width: 120px;
        }

        .variant-actions button {
            margin: 0;
            padding: 8px 12px;
            font-size: 12px;
            white-space: nowrap;
        }

        .color-preview {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 2px solid #ddd;
            vertical-align: middle;
            margin-right: 5px;
        }

        .stock-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .stock-badge.in-stock {
            background: #d4edda;
            color: #155724;
        }

        .stock-badge.low-stock {
            background: #fff3cd;
            color: #856404;
        }

        .stock-badge.out-of-stock {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üõí Test E-commerce API</h1>

        <!-- Authentication Section -->
        <div class="auth-section">
            <h2>üîê Authentification</h2>
            <div id="authStatus" class="status info">Non connect√©</div>

            <div class="form-group">
                <label>Email</label>
                <input type="email" id="loginEmail" value="admin@example.com" placeholder="admin@example.com">
            </div>
            <div class="form-group">
                <label>Mot de passe</label>
                <input type="password" id="loginPassword" value="Admin123" placeholder="Admin123">
            </div>
            <button onclick="login()">Se connecter</button>
            <button onclick="logout()" class="secondary">Se d√©connecter</button>
        </div>

        <div class="grid">
            <!-- Categories Section -->
            <div class="card">
                <h2>üìÅ Cat√©gories</h2>
                <button onclick="loadCategories()">Charger les cat√©gories</button>
                <button onclick="showCreateCategory()" class="success">Nouvelle cat√©gorie</button>

                <div id="createCategoryForm" class="hidden" style="margin-top: 15px;">
                    <div class="form-group">
                        <label>Nom</label>
                        <input type="text" id="categoryName" placeholder="√âlectronique">
                    </div>
                    <div class="form-group">
                        <label>Slug</label>
                        <input type="text" id="categorySlug" placeholder="electronique">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="categoryDesc" rows="2"></textarea>
                    </div>
                    <button onclick="createCategory()">Cr√©er</button>
                    <button onclick="hideCreateCategory()" class="secondary">Annuler</button>
                </div>

                <div id="categoryList" class="category-list"></div>
            </div>

            <!-- Products Section -->
            <div class="card">
                <h2>üì¶ Produits</h2>
                <button onclick="loadProducts()">Charger les produits</button>
                <button onclick="showCreateProduct()" class="success">Nouveau produit</button>

                <div id="createProductForm" class="hidden" style="margin-top: 15px;">
                    <div class="form-group">
                        <label>Nom</label>
                        <input type="text" id="productName" placeholder="iPhone 15">
                    </div>
                    <div class="form-group">
                        <label>Slug</label>
                        <input type="text" id="productSlug" placeholder="iphone-15">
                    </div>
                    <div class="form-group">
                        <label>Prix (‚Ç¨)</label>
                        <input type="number" id="productPrice" placeholder="999.99" step="0.01">
                    </div>
                    <div class="form-group">
                        <label>Stock</label>
                        <input type="number" id="productQuantity" placeholder="50">
                    </div>
                    <div class="form-group">
                        <label>SKU</label>
                        <input type="text" id="productSku" placeholder="IPH15-001">
                    </div>
                    <div class="form-group">
                        <label>Cat√©gorie ID</label>
                        <input type="text" id="productCategory" placeholder="ID de la cat√©gorie">
                    </div>
                    <button onclick="createProduct()">Cr√©er</button>
                    <button onclick="hideCreateProduct()" class="secondary">Annuler</button>
                </div>

                <div id="productList" class="product-list"></div>

                <!-- Image Upload Section -->
                <div id="imageUploadSection" class="hidden" style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #f0f0f0;">
                    <h3 style="color: #667eea; margin-bottom: 15px;">üì∏ Gestion des Images</h3>
                    <div class="form-group">
                        <label>S√©lectionner des images (max 5, 5MB chacune)</label>
                        <input type="file" id="productImages" accept="image/jpeg,image/jpg,image/png,image/webp" multiple>
                    </div>
                    <button onclick="uploadProductImages()" class="success">Upload Images</button>
                    <button onclick="hideImageUpload()" class="secondary">Fermer</button>

                    <div id="currentProductImages" style="margin-top: 20px;"></div>
                </div>
            </div>
        </div>

        <!-- Product Variants Section -->
        <div class="card" style="margin-top: 20px;">
            <h2>üé® Gestion des Variantes</h2>
            <p style="color: #666; margin-bottom: 15px;">G√©rer les tailles, couleurs et stock des variantes de produits</p>

            <div style="margin-bottom: 15px;">
                <button onclick="showCreateVariant()" class="success">+ Ajouter une variante</button>
                <button onclick="loadAllVariants()">Charger toutes les variantes</button>
            </div>

            <!-- Create/Edit Variant Form -->
            <div id="createVariantForm" class="hidden" style="border: 2px solid #667eea; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h3 style="color: #667eea; margin-bottom: 15px;">Nouvelle Variante</h3>

                <div class="form-group">
                    <label>Produit Parent *</label>
                    <select id="variantProductId" required>
                        <option value="">-- S√©lectionner un produit --</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>SKU * (ex: TSHIRT-ROUGE-M)</label>
                    <input type="text" id="variantSku" placeholder="TSHIRT-ROUGE-M" required>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Taille (ex: S, M, L, XL, 36, 38)</label>
                        <input type="text" id="variantSize" placeholder="M">
                    </div>

                    <div class="form-group">
                        <label>Couleur</label>
                        <input type="text" id="variantColor" placeholder="Rouge">
                    </div>
                </div>

                <div class="form-group">
                    <label>Code Couleur Hexad√©cimal (ex: #FF0000)</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="text" id="variantColorHex" placeholder="#FF0000" pattern="^#[0-9A-Fa-f]{6}$" style="flex: 1;">
                        <input type="color" id="variantColorPicker" style="width: 50px; height: 35px; border: none; cursor: pointer;">
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Prix (‚Ç¨) (laisser vide pour utiliser le prix du produit parent)</label>
                        <input type="number" id="variantPrice" step="0.01" min="0" placeholder="19.99">
                    </div>

                    <div class="form-group">
                        <label>Prix Compar√© (‚Ç¨) (prix barr√©)</label>
                        <input type="number" id="variantComparePrice" step="0.01" min="0" placeholder="29.99">
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Quantit√© en Stock *</label>
                        <input type="number" id="variantQuantity" value="0" min="0" required>
                    </div>

                    <div class="form-group">
                        <label>Poids (kg)</label>
                        <input type="number" id="variantWeight" step="0.01" min="0" placeholder="0.25">
                    </div>

                    <div class="form-group">
                        <label>Code-barres</label>
                        <input type="text" id="variantBarcode" placeholder="123456789012">
                    </div>
                </div>

                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="variantIsActive" checked>
                        Variante active et disponible √† la vente
                    </label>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="createVariant()" class="success">Cr√©er la Variante</button>
                    <button onclick="hideCreateVariant()" class="secondary">Annuler</button>
                </div>
            </div>

            <!-- Filter Section -->
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <h4 style="margin-bottom: 10px;">üîç Filtres</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                    <select id="filterProductId" onchange="filterVariants()">
                        <option value="">Tous les produits</option>
                    </select>
                    <input type="text" id="filterSize" placeholder="Filtrer par taille" onkeyup="filterVariants()">
                    <input type="text" id="filterColor" placeholder="Filtrer par couleur" onkeyup="filterVariants()">
                    <select id="filterStock" onchange="filterVariants()">
                        <option value="">Tous les stocks</option>
                        <option value="in_stock">En stock uniquement</option>
                        <option value="out_of_stock">Rupture de stock</option>
                    </select>
                    <select id="filterActive" onchange="filterVariants()">
                        <option value="">Toutes</option>
                        <option value="true">Actives</option>
                        <option value="false">Inactives</option>
                    </select>
                </div>
            </div>

            <!-- Variant List -->
            <div id="variantList" class="variant-list"></div>

            <!-- Update Stock Modal -->
            <div id="updateStockModal" class="hidden" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); z-index: 1000; min-width: 400px;">
                <h3 style="color: #667eea; margin-bottom: 20px;">Mettre √† jour le stock</h3>
                <input type="hidden" id="stockVariantId">

                <div class="form-group">
                    <label>Op√©ration</label>
                    <select id="stockOperation">
                        <option value="set">D√©finir le stock (remplacer)</option>
                        <option value="add">Ajouter au stock</option>
                        <option value="subtract">Retirer du stock</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Quantit√©</label>
                    <input type="number" id="stockQuantity" min="0" value="0">
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="updateStock()" class="success">Valider</button>
                    <button onclick="hideUpdateStockModal()" class="secondary">Annuler</button>
                </div>
            </div>
            <div id="modalOverlay" class="hidden" onclick="hideUpdateStockModal()" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 999;"></div>
        </div>

        <div class="grid">
            <!-- Cart Section -->
            <div class="card">
                <h2>üõí Panier</h2>
                <button onclick="loadCart()">Charger le panier</button>
                <button onclick="clearCart()" class="secondary">Vider le panier</button>

                <div id="cartItems" class="cart-items"></div>
                <div id="cartTotal"></div>
            </div>

            <!-- Orders Section -->
            <div class="card">
                <h2>üìã Commandes</h2>
                <button onclick="loadOrders()">Mes commandes</button>
                <button onclick="showCreateOrder()" class="success">Cr√©er une commande</button>

                <div id="createOrderForm" class="hidden" style="margin-top: 15px;">
                    <h3>Adresse de livraison</h3>
                    <div class="form-group">
                        <label>Rue</label>
                        <input type="text" id="orderStreet" placeholder="123 rue de la Paix">
                    </div>
                    <div class="form-group">
                        <label>Ville</label>
                        <input type="text" id="orderCity" placeholder="Paris">
                    </div>
                    <div class="form-group">
                        <label>Code postal</label>
                        <input type="text" id="orderPostal" placeholder="75001">
                    </div>
                    <div class="form-group">
                        <label>Pays</label>
                        <input type="text" id="orderCountry" value="France">
                    </div>
                    <div class="form-group">
                        <label>T√©l√©phone</label>
                        <input type="text" id="orderPhone" placeholder="+33612345678">
                    </div>
                    <div class="form-group">
                        <label>Mode de paiement</label>
                        <select id="orderPayment">
                            <option value="credit_card">Carte bancaire</option>
                            <option value="paypal">PayPal</option>
                            <option value="bank_transfer">Virement</option>
                        </select>
                    </div>
                    <button onclick="createOrder()">Commander</button>
                    <button onclick="hideCreateOrder()" class="secondary">Annuler</button>
                </div>

                <div id="orderList" class="order-list"></div>
            </div>
        </div>

        <!-- Debug Section -->
        <div class="card" style="margin-top: 20px;">
            <h2>üîß Debug - Derni√®re r√©ponse API</h2>
            <pre id="debugResponse">Aucune requ√™te effectu√©e</pre>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:3000/api';
        let authToken = localStorage.getItem('authToken') || null;

        // Update auth status on load
        updateAuthStatus();

        function updateAuthStatus() {
            const statusDiv = document.getElementById('authStatus');
            if (authToken) {
                statusDiv.className = 'status success';
                statusDiv.textContent = '‚úÖ Connect√©';
            } else {
                statusDiv.className = 'status info';
                statusDiv.textContent = '‚ùå Non connect√©';
            }
        }

        async function apiCall(endpoint, method = 'GET', body = null) {
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                }
            };

            if (authToken) {
                options.headers['Authorization'] = `Bearer ${authToken}`;
            }

            if (body) {
                options.body = JSON.stringify(body);
            }

            try {
                const response = await fetch(`${API_URL}${endpoint}`, options);
                const data = await response.json();

                document.getElementById('debugResponse').textContent =
                    JSON.stringify(data, null, 2);

                if (!response.ok) {
                    throw new Error(data.message || 'Erreur API');
                }

                return data;
            } catch (error) {
                console.error('API Error:', error);
                alert('Erreur: ' + error.message);
                throw error;
            }
        }

        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const data = await apiCall('/auth/login', 'POST', { email, password });
                authToken = data.data.token;
                localStorage.setItem('authToken', authToken);
                updateAuthStatus();
                alert('‚úÖ Connexion r√©ussie!');
            } catch (error) {
                console.error('Login error:', error);
            }
        }

        function logout() {
            authToken = null;
            localStorage.removeItem('authToken');
            updateAuthStatus();
            alert('D√©connect√©');
        }

        // Categories
        function showCreateCategory() {
            document.getElementById('createCategoryForm').classList.remove('hidden');
        }

        function hideCreateCategory() {
            document.getElementById('createCategoryForm').classList.add('hidden');
        }

        async function createCategory() {
            const body = {
                name: document.getElementById('categoryName').value,
                slug: document.getElementById('categorySlug').value,
                description: document.getElementById('categoryDesc').value,
                is_active: true,
                sort_order: 1
            };

            try {
                await apiCall('/categories', 'POST', body);
                alert('‚úÖ Cat√©gorie cr√©√©e!');
                hideCreateCategory();
                loadCategories();
            } catch (error) {
                console.error('Error creating category:', error);
            }
        }

        async function loadCategories() {
            try {
                const data = await apiCall('/categories');
                const listDiv = document.getElementById('categoryList');

                if (data.data.length === 0) {
                    listDiv.innerHTML = '<p>Aucune cat√©gorie</p>';
                    return;
                }

                listDiv.innerHTML = data.data.map(cat => `
                    <div class="category-item">
                        <h3>${cat.name}</h3>
                        <p><strong>Slug:</strong> ${cat.slug}</p>
                        <p><strong>ID:</strong> ${cat.id}</p>
                        ${cat.description ? `<p>${cat.description}</p>` : ''}
                        <span class="badge ${cat.is_active ? 'success' : 'danger'}">
                            ${cat.is_active ? 'Actif' : 'Inactif'}
                        </span>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }

        // Products
        function showCreateProduct() {
            document.getElementById('createProductForm').classList.remove('hidden');
        }

        function hideCreateProduct() {
            document.getElementById('createProductForm').classList.add('hidden');
        }

        async function createProduct() {
            const body = {
                name: document.getElementById('productName').value,
                slug: document.getElementById('productSlug').value,
                price: parseFloat(document.getElementById('productPrice').value),
                quantity: parseInt(document.getElementById('productQuantity').value),
                sku: document.getElementById('productSku').value,
                category_id: document.getElementById('productCategory').value || null,
                is_active: true,
                track_inventory: true
            };

            try {
                await apiCall('/products', 'POST', body);
                alert('‚úÖ Produit cr√©√©!');
                hideCreateProduct();
                loadProducts();
            } catch (error) {
                console.error('Error creating product:', error);
            }
        }

        async function loadProducts() {
            try {
                const data = await apiCall('/products');
                const listDiv = document.getElementById('productList');

                if (data.data.length === 0) {
                    listDiv.innerHTML = '<p>Aucun produit</p>';
                    return;
                }

                listDiv.innerHTML = data.data.map(product => `
                    <div class="product-item">
                        ${product.images && product.images.length > 0 ?
                            `<img src="${product.images[0].thumbnail}" alt="${product.name}" style="width: 100%; height: 150px; object-fit: cover; border-radius: 8px; margin-bottom: 10px;">`
                            : ''}
                        <h3>${product.name}</h3>
                        <p class="price">${product.price}‚Ç¨</p>
                        <p><strong>Stock:</strong> ${product.quantity}</p>
                        <p><strong>SKU:</strong> ${product.sku || 'N/A'}</p>
                        <p><strong>ID:</strong> ${product.id}</p>
                        <span class="badge ${product.is_active ? 'success' : 'danger'}">
                            ${product.is_active ? 'Actif' : 'Inactif'}
                        </span>
                        <button onclick="addToCart('${product.id}', 1)" class="success" style="margin-top: 10px;">
                            Ajouter au panier
                        </button>
                        <button onclick="manageImages('${product.id}')" style="margin-top: 10px;">
                            üì∏ Images (${product.images ? product.images.length : 0})
                        </button>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading products:', error);
            }
        }

        // Cart
        async function addToCart(productId, quantity = 1) {
            try {
                await apiCall('/cart/my-cart/items', 'POST', { product_id: productId, quantity });
                alert('‚úÖ Produit ajout√© au panier!');
                loadCart();
            } catch (error) {
                console.error('Error adding to cart:', error);
            }
        }

        async function loadCart() {
            try {
                const data = await apiCall('/cart/my-cart');
                const itemsDiv = document.getElementById('cartItems');
                const totalDiv = document.getElementById('cartTotal');

                if (!data.data.items || data.data.items.length === 0) {
                    itemsDiv.innerHTML = '<p>Panier vide</p>';
                    totalDiv.innerHTML = '';
                    return;
                }

                itemsDiv.innerHTML = data.data.items.map(item => `
                    <div class="cart-item">
                        <h3>${item.product.name}</h3>
                        <p><strong>Prix unitaire:</strong> ${item.price}‚Ç¨</p>
                        <p><strong>Quantit√©:</strong> ${item.quantity}</p>
                        <p><strong>Sous-total:</strong> ${(item.price * item.quantity).toFixed(2)}‚Ç¨</p>
                        <button onclick="removeFromCart('${item.id}')" class="secondary">
                            Retirer
                        </button>
                    </div>
                `).join('');

                totalDiv.innerHTML = `
                    <div class="total-cart">
                        <h3>Total: ${data.data.total.toFixed(2)}‚Ç¨</h3>
                        <p>${data.data.items_count} article(s)</p>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading cart:', error);
            }
        }

        async function removeFromCart(itemId) {
            try {
                await apiCall(`/cart/my-cart/items/${itemId}`, 'DELETE');
                alert('‚úÖ Article retir√© du panier!');
                loadCart();
            } catch (error) {
                console.error('Error removing from cart:', error);
            }
        }

        async function clearCart() {
            if (!confirm('Voulez-vous vraiment vider le panier?')) return;

            try {
                await apiCall('/cart/my-cart', 'DELETE');
                alert('‚úÖ Panier vid√©!');
                loadCart();
            } catch (error) {
                console.error('Error clearing cart:', error);
            }
        }

        // Orders
        function showCreateOrder() {
            document.getElementById('createOrderForm').classList.remove('hidden');
        }

        function hideCreateOrder() {
            document.getElementById('createOrderForm').classList.add('hidden');
        }

        async function createOrder() {
            const body = {
                shipping_address: {
                    street: document.getElementById('orderStreet').value,
                    city: document.getElementById('orderCity').value,
                    postal_code: document.getElementById('orderPostal').value,
                    country: document.getElementById('orderCountry').value,
                    phone: document.getElementById('orderPhone').value
                },
                payment_method: document.getElementById('orderPayment').value
            };

            try {
                await apiCall('/orders/create', 'POST', body);
                alert('‚úÖ Commande cr√©√©e avec succ√®s!');
                hideCreateOrder();
                loadOrders();
                loadCart(); // Refresh cart (should be empty now)
            } catch (error) {
                console.error('Error creating order:', error);
            }
        }

        async function loadOrders() {
            try {
                const data = await apiCall('/orders/my-orders');
                const listDiv = document.getElementById('orderList');

                if (data.data.length === 0) {
                    listDiv.innerHTML = '<p>Aucune commande</p>';
                    return;
                }

                listDiv.innerHTML = data.data.map(order => `
                    <div class="order-item">
                        <h3>Commande ${order.order_number}</h3>
                        <p><strong>Total:</strong> ${order.total}‚Ç¨ TTC</p>
                        <p><strong>Sous-total:</strong> ${order.subtotal}‚Ç¨</p>
                        <p><strong>TVA:</strong> ${order.tax}‚Ç¨</p>
                        <p><strong>Livraison:</strong> ${order.shipping_cost}‚Ç¨</p>
                        <p><strong>Articles:</strong> ${order.items.length}</p>
                        <p><strong>Date:</strong> ${new Date(order.createdAt).toLocaleString('fr-FR')}</p>
                        <span class="badge info">${order.status}</span>
                        <span class="badge ${order.payment_status === 'paid' ? 'success' : 'warning'}">
                            ${order.payment_status}
                        </span>
                        ${order.items.map(item => `
                            <p style="margin-left: 15px; margin-top: 5px;">
                                ‚Ä¢ ${item.quantity}√ó ${item.product_name} - ${item.price}‚Ç¨
                            </p>
                        `).join('')}
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading orders:', error);
            }
        }

        // Image Management
        let currentProductId = null;

        async function manageImages(productId) {
            currentProductId = productId;
            document.getElementById('imageUploadSection').classList.remove('hidden');
            document.getElementById('productImages').value = '';
            await loadProductImages(productId);
        }

        function hideImageUpload() {
            document.getElementById('imageUploadSection').classList.add('hidden');
            currentProductId = null;
        }

        async function loadProductImages(productId) {
            try {
                const data = await apiCall(`/products/${productId}`);
                const product = data.data;
                const imagesDiv = document.getElementById('currentProductImages');

                if (!product.images || product.images.length === 0) {
                    imagesDiv.innerHTML = `
                        <div style="text-align: center; padding: 30px; background: #f8f9fa; border-radius: 8px; border: 2px dashed #ddd;">
                            <p style="color: #888; font-size: 16px; margin: 0;">üì∑ Aucune image pour ce produit</p>
                            <p style="color: #aaa; font-size: 14px; margin-top: 8px;">Utilisez le s√©lecteur ci-dessus pour ajouter des images</p>
                        </div>
                    `;
                    return;
                }

                imagesDiv.innerHTML = `
                    <h4 style="color: #667eea; margin-bottom: 10px;">Images actuelles (${product.images.length})</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px;">
                        ${product.images.map((img, index) => `
                            <div style="position: relative; border: 2px solid #e0e0e0; border-radius: 8px; padding: 5px; background: white;">
                                <img src="${img.thumbnail}" alt="Product image ${index + 1}"
                                     style="width: 100%; height: 150px; object-fit: cover; border-radius: 6px; cursor: pointer;"
                                     onclick="window.open('${img.large}', '_blank')"
                                     onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                <div style="display: none; width: 100%; height: 150px; background: #f0f0f0; border-radius: 6px; text-align: center; line-height: 150px; color: #999;">
                                    Image introuvable
                                </div>
                                <button onclick="deleteImage('${productId}', ${index})"
                                        class="danger"
                                        style="width: 100%; margin-top: 5px; padding: 5px; font-size: 12px;">
                                    ‚ùå Supprimer
                                </button>
                                ${index === 0 ? '<span style="position: absolute; top: 10px; left: 10px; background: #667eea; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px;">Principal</span>' : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
            } catch (error) {
                console.error('Error loading product images:', error);
                document.getElementById('currentProductImages').innerHTML = `
                    <div style="text-align: center; padding: 20px; background: #fee; border-radius: 8px; border: 2px solid #fcc;">
                        <p style="color: #c33; margin: 0;">‚ùå Erreur lors du chargement des images</p>
                    </div>
                `;
            }
        }

        async function uploadProductImages() {
            if (!currentProductId) {
                alert('‚ùå Aucun produit s√©lectionn√©');
                return;
            }

            const fileInput = document.getElementById('productImages');
            const files = fileInput.files;

            if (files.length === 0) {
                alert('‚ùå Veuillez s√©lectionner au moins une image');
                return;
            }

            if (files.length > 5) {
                alert('‚ùå Maximum 5 images √† la fois');
                return;
            }

            // V√©rifier la taille des fichiers
            for (let i = 0; i < files.length; i++) {
                if (files[i].size > 5 * 1024 * 1024) {
                    alert(`‚ùå Le fichier ${files[i].name} est trop volumineux (max 5MB)`);
                    return;
                }
            }

            const formData = new FormData();
            for (let i = 0; i < files.length; i++) {
                formData.append('images', files[i]);
            }

            try {
                const response = await fetch(`http://localhost:3000/api/products/${currentProductId}/images`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: formData
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.message || 'Erreur lors de l\'upload');
                }

                alert(`‚úÖ ${files.length} image(s) upload√©e(s) avec succ√®s!`);
                fileInput.value = '';
                await loadProductImages(currentProductId);
                await loadProducts(); // Refresh product list to show new images
            } catch (error) {
                console.error('Error uploading images:', error);
                alert('‚ùå Erreur: ' + error.message);
            }
        }

        async function deleteImage(productId, imageIndex) {
            if (!confirm('√ätes-vous s√ªr de vouloir supprimer cette image ?')) {
                return;
            }

            try {
                await apiCall(`/products/${productId}/images/${imageIndex}`, 'DELETE');
                alert('‚úÖ Image supprim√©e avec succ√®s!');
                await loadProductImages(productId);
                await loadProducts(); // Refresh product list
            } catch (error) {
                console.error('Error deleting image:', error);
                alert('‚ùå Erreur lors de la suppression de l\'image');
            }
        }

        // ============================================
        // VARIANT MANAGEMENT FUNCTIONS
        // ============================================

        let allVariants = [];

        // Show/Hide Forms
        function showCreateVariant() {
            document.getElementById('createVariantForm').classList.remove('hidden');
            loadProductsForDropdown();
        }

        function hideCreateVariant() {
            document.getElementById('createVariantForm').classList.add('hidden');
            clearVariantForm();
        }

        function clearVariantForm() {
            document.getElementById('variantProductId').value = '';
            document.getElementById('variantSku').value = '';
            document.getElementById('variantSize').value = '';
            document.getElementById('variantColor').value = '';
            document.getElementById('variantColorHex').value = '';
            document.getElementById('variantColorPicker').value = '#000000';
            document.getElementById('variantPrice').value = '';
            document.getElementById('variantComparePrice').value = '';
            document.getElementById('variantQuantity').value = '0';
            document.getElementById('variantWeight').value = '';
            document.getElementById('variantBarcode').value = '';
            document.getElementById('variantIsActive').checked = true;
        }

        // Color Picker Sync
        document.addEventListener('DOMContentLoaded', function() {
            const colorPicker = document.getElementById('variantColorPicker');
            const colorHex = document.getElementById('variantColorHex');

            if (colorPicker && colorHex) {
                colorPicker.addEventListener('input', (e) => {
                    colorHex.value = e.target.value.toUpperCase();
                });

                colorHex.addEventListener('input', (e) => {
                    const hex = e.target.value;
                    if (/^#[0-9A-Fa-f]{6}$/.test(hex)) {
                        colorPicker.value = hex;
                    }
                });
            }
        });

        // Load Products for Dropdown
        async function loadProductsForDropdown() {
            try {
                const data = await apiCall('/products');
                const productSelect = document.getElementById('variantProductId');
                const filterSelect = document.getElementById('filterProductId');

                const options = data.data.map(p =>
                    `<option value="${p.id}">${p.name} (${p.sku || 'N/A'})</option>`
                ).join('');

                productSelect.innerHTML = '<option value="">-- S√©lectionner un produit --</option>' + options;
                filterSelect.innerHTML = '<option value="">Tous les produits</option>' + options;
            } catch (error) {
                console.error('Error loading products:', error);
            }
        }

        // Create Variant
        async function createVariant() {
            const productId = document.getElementById('variantProductId').value;
            if (!productId) {
                alert('‚ùå Veuillez s√©lectionner un produit');
                return;
            }

            const body = {
                sku: document.getElementById('variantSku').value.trim(),
                size: document.getElementById('variantSize').value.trim() || null,
                color: document.getElementById('variantColor').value.trim() || null,
                color_hex: document.getElementById('variantColorHex').value.trim() || null,
                quantity: parseInt(document.getElementById('variantQuantity').value) || 0,
                is_active: document.getElementById('variantIsActive').checked
            };

            // Optional fields
            const price = document.getElementById('variantPrice').value.trim();
            if (price) body.price = parseFloat(price);

            const comparePrice = document.getElementById('variantComparePrice').value.trim();
            if (comparePrice) body.compare_price = parseFloat(comparePrice);

            const weight = document.getElementById('variantWeight').value.trim();
            if (weight) body.weight = parseFloat(weight);

            const barcode = document.getElementById('variantBarcode').value.trim();
            if (barcode) body.barcode = barcode;

            if (!body.sku) {
                alert('‚ùå Le SKU est requis');
                return;
            }

            try {
                await apiCall(`/products/${productId}/variants`, 'POST', body);
                alert('‚úÖ Variante cr√©√©e avec succ√®s!');
                hideCreateVariant();
                loadAllVariants();
            } catch (error) {
                console.error('Error creating variant:', error);
            }
        }

        // Load All Variants
        async function loadAllVariants() {
            try {
                const data = await apiCall('/products');
                allVariants = [];

                // Collect all variants from all products
                for (const product of data.data) {
                    if (product.has_variants) {
                        const variantData = await apiCall(`/products/${product.id}/variants`);
                        if (variantData.data && variantData.data.length > 0) {
                            allVariants.push(...variantData.data);
                        }
                    }
                }

                displayVariants(allVariants);
                loadProductsForDropdown(); // Refresh dropdowns
            } catch (error) {
                console.error('Error loading variants:', error);
            }
        }

        // Display Variants
        function displayVariants(variants) {
            const listDiv = document.getElementById('variantList');

            if (!variants || variants.length === 0) {
                listDiv.innerHTML = '<p style="text-align: center; color: #888; padding: 40px;">Aucune variante trouv√©e</p>';
                return;
            }

            listDiv.innerHTML = variants.map(variant => {
                const stockClass = variant.quantity > 10 ? 'in-stock' : variant.quantity > 0 ? 'low-stock' : 'out-of-stock';
                const stockText = variant.quantity > 0 ? `${variant.quantity} en stock` : 'Rupture';

                return `
                    <div class="variant-item">
                        <div class="variant-info">
                            <div class="variant-info-item">
                                <span class="variant-info-label">SKU</span>
                                <span class="variant-info-value">${variant.sku}</span>
                            </div>
                            <div class="variant-info-item">
                                <span class="variant-info-label">Produit</span>
                                <span class="variant-info-value">${variant.product ? variant.product.name : 'N/A'}</span>
                            </div>
                            ${variant.size ? `
                                <div class="variant-info-item">
                                    <span class="variant-info-label">Taille</span>
                                    <span class="variant-info-value">${variant.size}</span>
                                </div>
                            ` : ''}
                            ${variant.color ? `
                                <div class="variant-info-item">
                                    <span class="variant-info-label">Couleur</span>
                                    <span class="variant-info-value">
                                        ${variant.color_hex ? `<span class="color-preview" style="background-color: ${variant.color_hex}"></span>` : ''}
                                        ${variant.color}
                                    </span>
                                </div>
                            ` : ''}
                            <div class="variant-info-item">
                                <span class="variant-info-label">Prix</span>
                                <span class="variant-info-value">${variant.price ? variant.price + '‚Ç¨' : 'Prix du produit'}</span>
                            </div>
                            <div class="variant-info-item">
                                <span class="variant-info-label">Stock</span>
                                <span class="stock-badge ${stockClass}">${stockText}</span>
                            </div>
                            <div class="variant-info-item">
                                <span class="variant-info-label">Statut</span>
                                <span class="badge ${variant.is_active ? 'success' : 'danger'}">
                                    ${variant.is_active ? 'Active' : 'Inactive'}
                                </span>
                            </div>
                        </div>
                        <div class="variant-actions">
                            <button onclick="showUpdateStockModal('${variant.id}')" style="background: #4facfe;">
                                üì¶ Stock
                            </button>
                            <button onclick="toggleVariantStatus('${variant.id}', ${variant.is_active})" class="${variant.is_active ? 'secondary' : 'success'}">
                                ${variant.is_active ? '‚è∏Ô∏è D√©sactiver' : '‚ñ∂Ô∏è Activer'}
                            </button>
                            <button onclick="deleteVariant('${variant.id}')" class="secondary" style="background: #f5576c;">
                                üóëÔ∏è Supprimer
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Filter Variants
        function filterVariants() {
            const productId = document.getElementById('filterProductId').value;
            const size = document.getElementById('filterSize').value.toLowerCase().trim();
            const color = document.getElementById('filterColor').value.toLowerCase().trim();
            const stockFilter = document.getElementById('filterStock').value;
            const activeFilter = document.getElementById('filterActive').value;

            let filtered = [...allVariants];

            if (productId) {
                filtered = filtered.filter(v => v.product_id === productId);
            }

            if (size) {
                filtered = filtered.filter(v => v.size && v.size.toLowerCase().includes(size));
            }

            if (color) {
                filtered = filtered.filter(v => v.color && v.color.toLowerCase().includes(color));
            }

            if (stockFilter === 'in_stock') {
                filtered = filtered.filter(v => v.quantity > 0);
            } else if (stockFilter === 'out_of_stock') {
                filtered = filtered.filter(v => v.quantity === 0);
            }

            if (activeFilter !== '') {
                const isActive = activeFilter === 'true';
                filtered = filtered.filter(v => v.is_active === isActive);
            }

            displayVariants(filtered);
        }

        // Stock Management Modal
        function showUpdateStockModal(variantId) {
            document.getElementById('stockVariantId').value = variantId;
            document.getElementById('stockQuantity').value = '0';
            document.getElementById('stockOperation').value = 'set';
            document.getElementById('updateStockModal').classList.remove('hidden');
            document.getElementById('modalOverlay').classList.remove('hidden');
        }

        function hideUpdateStockModal() {
            document.getElementById('updateStockModal').classList.add('hidden');
            document.getElementById('modalOverlay').classList.add('hidden');
        }

        async function updateStock() {
            const variantId = document.getElementById('stockVariantId').value;
            const quantity = parseInt(document.getElementById('stockQuantity').value);
            const operation = document.getElementById('stockOperation').value;

            if (isNaN(quantity) || quantity < 0) {
                alert('‚ùå Quantit√© invalide');
                return;
            }

            try {
                await apiCall(`/variants/${variantId}/stock`, 'PATCH', {
                    quantity,
                    operation
                });
                alert('‚úÖ Stock mis √† jour avec succ√®s!');
                hideUpdateStockModal();
                loadAllVariants();
            } catch (error) {
                console.error('Error updating stock:', error);
            }
        }

        // Toggle Variant Active Status
        async function toggleVariantStatus(variantId, currentStatus) {
            try {
                await apiCall(`/variants/${variantId}`, 'PUT', {
                    is_active: !currentStatus
                });
                alert(`‚úÖ Variante ${!currentStatus ? 'activ√©e' : 'd√©sactiv√©e'} avec succ√®s!`);
                loadAllVariants();
            } catch (error) {
                console.error('Error toggling variant status:', error);
            }
        }

        // Delete Variant
        async function deleteVariant(variantId) {
            if (!confirm('‚ö†Ô∏è Voulez-vous vraiment supprimer cette variante? Cette action est irr√©versible.')) {
                return;
            }

            try {
                await apiCall(`/variants/${variantId}`, 'DELETE');
                alert('‚úÖ Variante supprim√©e avec succ√®s!');
                loadAllVariants();
            } catch (error) {
                console.error('Error deleting variant:', error);
            }
        }
    </script>
</body>
</html>
